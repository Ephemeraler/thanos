## 目标
Query Instant Middleware

### Middleware
1. RoundTripper
   解码 http.Request To Request
   调用 Middleware
   编码 Response To http.Response

2. InstrumentMiddleware(Sharding)
   用于记录 Sharding 层及其之后操作的耗时时间.

3. ShardingMiddleware
   分析查询分片
   将主请求分片为多个子请求(多个执行窗口)
   合并分片(执行窗口)响应结果

4. StatsMiddleware
   StatesMiddleware 使用 MiddlewareFunc 实现, 该函数返回 statsMiddleware 类型变量(Handler)

   从 StatsMiddleware 来看, 一个执行窗口(execution windows)是指 frontend 为完成客户端请求而执行的一次子请求.

   StatsMiddleware 判断是否配置开启 stats 功能, 若未开启该层无作用, 若开启则会在downstream reqeust 中增加 stats 参数, 并统计各执行窗口
   返回的 stats 数据. 值得注意的是, statsmiddleware 层将 stats 数据写入到 context 中保存, 并不是写在 Response 中. 而 stats 数据应该是在 Handler.ServeHTTP 中最终使用返回给客户端.

5. RoundTripperMiddleware
   编码 Request To http.Request
   调用 RoundTrip(DownstramTripper)
   解码 http.Response To Response

### Thanos Frontend 指标
`frontend_query_range_duration_seconds{method="sharding",status_code=""}`: 记录 sharding middleware 及其之后处理执行时间. 这里需要注意的是, 虽然指标名称为 query_range 但是实际上 query instant 也有 sharding middleware 层.
`frontend_sharding_middleware_queries_total{shardable="true/false"}`: 记录客户端请求中 PromQL 是否能分片(这里不是执行窗口, 执行窗口是在分片之后), 分片的个数是多少.

## Coding

### func (r *http.Request) Context() context.Context
官文
```text
该函数返回 Request 的 context, 如果需要更改上下文, 请使用 [Request.Clone] 或 [Request.WithContext] 方法.
返回的上下文永远不会为 nil, 就算 Request's context 为空也会返回 Backgroud().
对于客户端发出的请求, 该上下文控制请求的取消.
对于服务器收到的请求, 该上下文会在以下情况被取消:
* 客户端连接关闭
* 请求被取消
* ServeHTTP 方法执行完毕
```


### context.Context
context.Context 是不可变接口(immutable), 不能直接修改它, 只能通过 With* 方法来生成一个"新 context". 但它们底层会引用原来的 context, 形成链式结构.

Go 的 context.Context 接口本质上是只读的, 目的是:
- 保证线程安全（concurrency-safe）
- 支持链式派生，避免副作用
- 简化设计和使用

`func (c Context) Value(key any) any`: 从 context 中获取携带的键值对. 它是 context 系列中唯一一个用于获取"自定义数据"的接口方法.

`子context会携带父context使用withValue创建的键值对吗?`: 子 context 会"继承"父 context 中使用 WithValue 设置的键值对, "继承"指的是值查找是递归进行的: 如果子 context 自己没有设置该 key, 会继续向父 context 查找, 直到找到或遍历完链路.


### github.com/weaveworks/common/instrument
由 Weaveworks 和 Cortex/Thanos 等项目团队维护的一个公共库. 专门用于方便、安全、一致地为请求添加 Prometheus 指标采集逻辑.


### 类型断言
形式: 接口变量.(type)
使用场景(唯一合法场景):

```go
switch <接口变量>.(type) {
   case <具体类型>:
      // statement
   case <具体类型>:
      // statement
}
```


### Prometheus Histogram
Histogram 会生成三个指标，`*_bucket`, `*_sum`, `*_count`.

`*_bucket <value>`: 表示某个统计桶出现的统计次数.
`*_sum`: 表示统计值之和
`*_count`: 表示统计次数总和.

举例:
```go
retriesCount: promauto.With(registerer).NewHistogram(prometheus.HistogramOpts{
   Namespace: "cortex",
   Name:      "query_frontend_retries",
   Help:      "Number of times a request is retried.",
   Buckets:   []float64{0, 1, 2, 3, 4, 5},
})
```
当 `retriesCount.Observe(2)` 时, `*_bucket{le='1'} *_bucket{le='0'}` 桶的统计次数 +1, `*_sum` 统计值 +2, `*_count` 统计次数 +1.